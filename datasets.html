<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dataset & Web Extractor — Column Builder + Discovery</title>
  <style>
    :root{--bg:#0b1020;--panel:#12182b;--text:#e7ecff;--muted:#a9b7ffcc;--chip:#1b2340;--card:#0f1527}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial,Noto Sans,sans-serif;background:linear-gradient(180deg,var(--bg),#070a14 40%);color:var(--text)}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(7,10,20,.95),rgba(7,10,20,.75));backdrop-filter:blur(6px);border-bottom:1px solid #1f2746}
    .container{max-width:1200px;margin:0 auto;padding:18px}
    h1{font-size:1.35rem;margin:0 0 10px}
    .panel{background:var(--panel);border:1px solid #20294a;border-radius:14px;padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,button,textarea{padding:10px 12px;border-radius:10px;border:1px solid #223160;background:#0a0f21;color:var(--text)}
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,#2a3c7d,#24356d);border-color:#2d3f80}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:999px;background:var(--chip);border:1px solid #23315f;font-size:.92rem}
    .grid{display:grid;gap:14px}
    @media(min-width:1100px){.grid-3{grid-template-columns:2fr 1.6fr 1.4fr}}
    .card{background:var(--card);border:1px solid #1c2546;border-radius:16px;overflow:hidden}
    .content{padding:12px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #1a2240;padding:8px;text-align:left;vertical-align:top}
    .empty{text-align:center;padding:28px 10px;color:var(--muted)}
    .hidden{display:none!important}
    .scroll{max-height:60vh;overflow:auto;-webkit-overflow-scrolling:touch}
    .small{font-size:.9rem}
    .col-grid{display:grid;grid-template-columns:1.2fr 1fr 0.9fr 1fr 1fr auto;gap:8px;align-items:center}
    .col-grid input[type="text"], .col-grid select{width:100%}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-size:.85rem}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Dataset & Web Extractor — Column Builder + Discovery</h1>
    </div>
  </header>

  <main class="container">
    <div class="panel">
      <div class="row" style="align-items:flex-start;justify-content:space-between">
        <div style="flex:2 1 520px">
          <div class="hint">Load a public page, then either <strong>discover</strong> likely containers/fields or manually build columns.</div>
          <div class="row" style="margin-top:8px">
            <input id="page-url" type="url" placeholder="https://example.com/list-or-article" style="flex:1"/>
            <button id="load-page" class="primary">Load</button>
            <button id="discover" title="Analyze the page for repeating containers & fields">Discover</button>
          </div>
          <div id="page-meta" class="small" style="margin-top:6px;color:var(--muted)"></div>
        </div>
        <div class="row" style="flex:1 1 340px; justify-content:flex-end">
          <label class="chip"><input type="checkbox" id="dedupe" checked/> deduplicate rows</label>
          <label class="chip"><input type="checkbox" id="absolute" checked/> make links absolute</label>
          <button id="extract" class="primary">Extract</button>
        </div>
      </div>
    </div>

    <div class="grid grid-3" style="margin-top:12px">
      <!-- Column Builder -->
      <section class="panel">
        <div class="row" style="margin-bottom:6px;align-items:center">
          <strong>Column Builder</strong>
          <input id="container-sel" placeholder="Container CSS (optional, e.g., .card, article, table tbody tr)" style="flex:1"/>
          <button id="add-col" class="chip">+ Add column</button>
          <button id="clear-cols" class="chip">Clear</button>
          <button id="preset-imdb" title="title/url/year/rating for common IMDb lists">Preset: IMDb</button>
        </div>
        <div id="cols" class="scroll"></div>
      </section>

      <!-- Discovery: Containers & Fields -->
      <section class="panel">
        <strong>Discover Containers</strong>
        <div id="containers" class="scroll" style="margin-top:6px"></div>
      </section>

      <section class="panel">
        <strong>Field Suggestions</strong>
        <div id="fields" class="scroll" style="margin-top:6px"></div>
      </section>
    </div>

    <section class="panel" style="margin-top:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="hint">Preview (<span id="row-count">0</span> rows)</div>
        <div class="row" style="gap:8px">
          <button id="download-json">Download JSON</button>
          <button id="download-csv">Download CSV</button>
        </div>
      </div>
      <div class="scroll">
        <table class="table" id="ex-table"></table>
      </div>
    </section>
  </main>

  <script>
    let PAGE = { url:'', html:'', doc:null };
    const parser = new DOMParser();
    const el = s=>document.querySelector(s);

    function toAbs(url, base){ try{ return new URL(url, base).toString(); }catch{ return url; } }
    function download(filename, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'application/octet-stream'})); a.download=filename; a.click(); }
    function toCSV(rows){ if(!rows.length) return ''; const cols=[...new Set(rows.flatMap(r=>Object.keys(r)))]; const esc=v=>(''+(v??'')).replace(/"/g,'""'); return [cols.join(','), ...rows.map(r=> cols.map(c=>`"${esc(r[c])}"`).join(','))].join('\n'); }

    function colRow(def={name:'title', selector:'', attr:'text', regex:'', replace:'', required:false}){
      const wrap=document.createElement('div'); wrap.className='col-grid'; wrap.style.margin='6px 0';
      wrap.innerHTML = `
        <input type="text" class="col-name" placeholder="Column name" value="${def.name||''}"/>
        <input type="text" class="col-sel mono" placeholder="Selector (relative)" value="${def.selector||''}"/>
        <select class="col-attr">
          <option value="text" ${def.attr==='text'?'selected':''}>text</option>
          <option value="href" ${def.attr==='href'?'selected':''}>href</option>
          <option value="src" ${def.attr==='src'?'selected':''}>src</option>
          <option value="title" ${def.attr==='title'?'selected':''}>title</option>
          <option value="datetime" ${def.attr==='datetime'?'selected':''}>datetime</option>
          <option value="content" ${def.attr==='content'?'selected':''}>content</option>
          <option value="aria-label" ${def.attr==='aria-label'?'selected':''}>aria-label</option>
        </select>
        <input type="text" class="col-regex mono" placeholder="Regex (optional)" value="${def.regex||''}"/>
        <input type="text" class="col-repl mono" placeholder="Replace with" value="${def.replace||''}"/>
        <label class="chip" title="Drop row if this column is empty" style="justify-self:start"><input type="checkbox" class="col-req" ${def.required?'checked':''}/> required</label>
        <button class="chip col-del" title="Remove column">✖</button>
      `;
      wrap.querySelector('.col-del').onclick=()=> wrap.remove();
      return wrap;
    }
    function getCols(){
      const rows=[...document.querySelectorAll('#cols .col-grid')];
      return rows.map(r=>({
        name: r.querySelector('.col-name').value.trim()||'col',
        selector: r.querySelector('.col-sel').value.trim(),
        attr: r.querySelector('.col-attr').value,
        regex: r.querySelector('.col-regex').value,
        replace: r.querySelector('.col-repl').value,
        required: r.querySelector('.col-req').checked,
      }));
    }
    function renderCols(list){ const box=el('#cols'); box.innerHTML=''; list.forEach(d=> box.appendChild(colRow(d))); if(!list.length) box.appendChild(colRow()); }

    function renderTable(rows){
      const table = document.getElementById('ex-table');
      table.innerHTML='';
      const countEl = document.getElementById('row-count');
      countEl.textContent = rows.length;
      if(!rows.length){ table.innerHTML='<tr><td class="empty">No rows</td></tr>'; return; }
      const cols = Array.from(new Set(rows.flatMap(r=>Object.keys(r))));
      const thead = `<thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead>`;
      const tbody = `<tbody>${rows.map(r=>`<tr>${cols.map(c=>`<td>${(r[c]??'').toString().replace(/[&<>]/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]))}</td>`).join('')}</tr>`).join('')}</tbody>`;
      table.innerHTML = thead + tbody;
    }

    async function loadPage(){
      const url = el('#page-url').value.trim(); if(!url) return alert('Enter a URL');
      el('#page-meta').textContent='Loading…';
      const prox=`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
      const r=await fetch(prox); if(!r.ok){ el('#page-meta').textContent='Failed to fetch (CORS/prerender blockers?)'; return; }
      const {contents=''}=await r.json();
      PAGE={url, html:contents, doc: parser.parseFromString(contents,'text/html')};
      const title = PAGE.doc.querySelector('title')?.textContent?.trim()||'(no title)';
      el('#page-meta').textContent = `Loaded: ${title}`;
      // clear discovery panes
      el('#containers').innerHTML=''; el('#fields').innerHTML='';
    }

    // ---------- Discovery ----------
    function nodeSig(n){
      if(!n || !n.tagName) return '';
      const tag = n.tagName.toLowerCase();
      const classes = (n.getAttribute('class')||'').split(/\s+/).filter(Boolean).slice(0,3).join('.');
      return classes? `${tag}.${classes}`: tag;
    }
    function cssOf(n){
      // Build a short CSS like div.card > h2.title
      const parts=[]; let cur=n; let depth=0;
      while(cur && cur.tagName && depth<4){ parts.unshift(nodeSig(cur)); cur=cur.parentElement; depth++; }
      return parts.join(' > ');
    }
    function topRepeatingContainers(doc){
      // Find candidates that repeat 6+ times and have at least a link/text inside
      const all = Array.from(doc.querySelectorAll('div, li, article, section, tr'));
      const map = new Map();
      all.forEach(n=>{ const sig=nodeSig(n); if(!sig) return; const key=sig; const arr=map.get(key)||[]; arr.push(n); map.set(key,arr); });
      const candidates = [];
      map.forEach((nodes, sig)=>{
        if(nodes.length<6) return;
        const good = nodes.filter(n=> n.querySelector('a[href], h1, h2, h3, p, time, img'));
        if(good.length >= 4){ candidates.push({sig, count:nodes.length, nodes}); }
      });
      candidates.sort((a,b)=> b.count - a.count);
      return candidates.slice(0,20);
    }
    function fieldSuggestions(containerNodes){
      // Within containers, suggest typical fields with relative selectors
      const rels = [
        {label:'title', sel:'h1, h2, h3, .title, [itemprop="name"]', attr:'text'},
        {label:'link', sel:'a[href]', attr:'href'},
        {label:'image', sel:'img', attr:'src'},
        {label:'date', sel:'time, [datetime]', attr:'datetime'},
        {label:'price', sel:'[class*="price"], [data-price]', attr:'text'},
        {label:'rating', sel:'[class*="rating"], [aria-label*="rating"]', attr:'text'},
        {label:'summary', sel:'p, .summary, .description', attr:'text'}
      ];
      // Build preview samples
      const samples=[];
      rels.forEach(r=>{
        const vals = [];
        containerNodes.slice(0,12).forEach(n=>{
          const t=n.querySelector(r.sel);
          if(!t) { vals.push(''); return; }
          let v='';
          if(r.attr==='text') v=(t.textContent||'').trim();
          else v=t.getAttribute(r.attr)||'';
          vals.push(v);
        });
        const nonEmpty = vals.filter(v=>v).length;
        if(nonEmpty>=3) samples.push({label:r.label, sel:r.sel, attr:r.attr, coverage:nonEmpty, vals});
      });
      samples.sort((a,b)=> b.coverage - a.coverage);
      return samples;
    }

    function renderContainers(cands){
      const box=el('#containers'); box.innerHTML='';
      if(!cands.length){ box.innerHTML='<div class="empty">Nothing obvious found. Try clicking Load again or a different page.</div>'; return; }
      cands.forEach(c=>{
        const btn=document.createElement('button'); btn.className='chip';
        btn.innerHTML = `<strong>${c.sig}</strong> <span class="mono">(${c.count})</span>`;
        btn.onclick=()=>{
          el('#container-sel').value = c.sig; // use sig as container selector
          const fields = fieldSuggestions(c.nodes);
          renderFields(fields);
        };
        box.appendChild(btn);
      });
    }
    function renderFields(list){
      const box=el('#fields'); box.innerHTML='';
      if(!list.length){ box.innerHTML='<div class="empty">No obvious fields inside that container. Try another.</div>'; return; }
      list.forEach(f=>{
        const card=document.createElement('div'); card.className='card';
        const c=document.createElement('div'); c.className='content';
        c.innerHTML = `<div><strong>${f.label}</strong> <span class="mono">(${f.attr})</span></div>
          <div class="small mono" style="opacity:.85;margin:6px 0">${f.sel}</div>
          <div class="small" style="opacity:.85">Samples:</div>
          <div class="mono small" style="white-space:pre-wrap; word-break:break-word; max-height:110px; overflow:auto">${f.vals.slice(0,6).map(v=> (v||'').toString().slice(0,140)).join('\n')}</div>
          <div class="row" style="margin-top:8px"><button class="chip">Add as column</button></div>`;
        const addBtn = c.querySelector('button');
        addBtn.onclick=()=>{
          // Add a column row with relative selector
          document.getElementById('cols').appendChild(colRow({name:f.label, selector:f.sel, attr:f.attr}));
        };
        card.appendChild(c); box.appendChild(card);
      });
    }

    async function discover(){
      if(!PAGE.doc){ alert('Load a page first'); return; }
      el('#containers').innerHTML='<div class="empty">Scanning…</div>';
      el('#fields').innerHTML='';
      // Generate container candidates
      const cands = topRepeatingContainers(PAGE.doc);
      renderContainers(cands);
      // If we found any, auto-select the top one to show field suggestions
      if(cands.length){ const fields = fieldSuggestions(cands[0].nodes); renderFields(fields); }
    }

    function applyRegex(str, rx, repl){ if(!rx) return str; try{ const r=new RegExp(rx,'g'); return (str??'').toString().replace(r, repl??''); }catch{ return str; } }
    function getText(n){ return (n?.textContent||'').trim(); }
    function getAttr(n,a){ return n?.getAttribute(a); }

    function extractColumns(){
      if(!PAGE.doc){ alert('Load a page first'); return []; }
      const abs = el('#absolute').checked;
      const containerSel = el('#container-sel').value.trim();
      const columns = getCols();
      let nodes = [];
      if(containerSel){ nodes = Array.from(PAGE.doc.querySelectorAll(containerSel)); }
      else {
        const first = columns.find(c=>c.selector); if(!first){ alert('Add at least one column with a selector'); return []; }
        nodes = Array.from(PAGE.doc.querySelectorAll(first.selector));
      }
      const rows=[];
      nodes.forEach(n=>{
        const row={}; let drop=false;
        columns.forEach(c=>{
          let target=n;
          if(containerSel && c.selector){ target=n.querySelector(c.selector); }
          else if(!containerSel && c.selector){ target=(c===columns[0])? n : PAGE.doc.querySelector(c.selector); }
          let val='';
          if(target){
            if(c.attr==='text') val=getText(target);
            else if(c.attr==='href' || c.attr==='src'){
              const raw=getAttr(target,c.attr); val = abs? toAbs(raw, PAGE.url): raw;
            } else { val=getAttr(target,c.attr); }
            val = applyRegex(val, c.regex, c.replace);
          }
          if(c.required && !val) drop=true;
          row[c.name]=val??'';
        });
        if(!drop) rows.push(row);
      });
      if(el('#dedupe').checked){ const seen=new Set(); return rows.filter(r=>{ const k=JSON.stringify(r); if(seen.has(k)) return false; seen.add(k); return true;}); }
      return rows;
    }

    function runAndRender(){ const rows = extractColumns(); renderTable(rows); window._rows = rows; }

    // Preset for IMDb-like list pages
    function presetIMDB(){
      el('#container-sel').value='table tbody tr, .lister-list .lister-item, .ipc-metadata-list-summary-item';
      renderCols([
        {name:'title', selector:'.titleColumn a, .lister-item-header a, .ipc-title-link-wrapper', attr:'text', required:true},
        {name:'url', selector:'.titleColumn a, .lister-item-header a, a.ipc-title-link-wrapper', attr:'href', required:true},
        {name:'year', selector:'.secondaryInfo, .lister-item-year, .cli-title-metadata-item:nth-child(1)', attr:'text', regex:'[^0-9]', replace:''},
        {name:'rating', selector:'.imdbRating strong, .ratings-imdb-rating strong, [aria-label*="rating"]', attr:'text'}
      ]);
    }

    // Bind UI
    document.getElementById('load-page').addEventListener('click', loadPage);
    document.getElementById('discover').addEventListener('click', discover);
    document.getElementById('add-col').addEventListener('click', ()=> document.getElementById('cols').appendChild(colRow({name:'col'})) );
    document.getElementById('clear-cols').addEventListener('click', ()=> renderCols([]));
    document.getElementById('extract').addEventListener('click', runAndRender);
    document.getElementById('preset-imdb').addEventListener('click', presetIMDB);
    document.getElementById('download-json').addEventListener('click', ()=> download('extracted.json', JSON.stringify(window._rows||[],null,2)));
    document.getElementById('download-csv').addEventListener('click', ()=> download('extracted.csv', toCSV(window._rows||[])));

    // init
    renderCols([]);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dataset Finder & Scraper</title>
  <style>
    :root{ --bg:#0b1020; --panel:#12182b; --text:#e7ecff; --muted:#9fb0ffcc; --chip:#1b2340; --card:#0f1527; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial,Noto Sans,sans-serif;background:linear-gradient(180deg,var(--bg),#070a14 40%);color:var(--text)}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(7,10,20,.95),rgba(7,10,20,.75));backdrop-filter:blur(6px);border-bottom:1px solid #1f2746}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    h1{font-size:1.35rem;margin:0 0 10px}
    .controls{display:grid;gap:10px;grid-template-columns:1fr}
    @media(min-width:900px){.controls{grid-template-columns:2.3fr 1fr}}
    .panel{background:var(--panel);border:1px solid #20294a;border-radius:14px;padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,button{padding:10px 12px;border-radius:10px;border:1px solid #223160;background:#0a0f21;color:var(--text)}
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,#2a3c7d,#24356d);border-color:#2d3f80}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:999px;background:var(--chip);border:1px solid #23315f;font-size:.92rem}
    .hint{color:var(--muted);font-size:.9rem}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media(min-width:700px){.grid{grid-template-columns:1fr 1fr}}
    @media(min-width:1024px){.grid{grid-template-columns:1fr 1fr 1fr}}
    .card{background:var(--card);border:1px solid #1c2546;border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
    .content{padding:12px}
    .meta{display:flex;justify-content:space-between;align-items:center;gap:8px;color:var(--muted);font-size:.85rem;margin-bottom:6px}
    .title a{color:var(--text);text-decoration:none;font-weight:600}
    .title a:hover{text-decoration:underline}
    .desc{color:#cdd6ff;font-size:.95rem}
    .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .tag{padding:4px 8px;border:1px solid #2a376b;border-radius:999px;font-size:.8rem;color:#bdd1ff}
    .empty{text-align:center;padding:40px 10px;color:var(--muted)}
    .hidden{display:none!important}
    #sources-panel{max-height:68vh;overflow:auto;-webkit-overflow-scrolling:touch}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div style="display:flex;justify-content:space-between;gap:12px;align-items:center">
        <h1>Dataset Finder & Lightweight Scraper</h1>
        <button id="toggle-controls" class="primary" style="white-space:nowrap">▲ Hide controls</button>
      </div>
      <div id="controls" class="controls">
        <div class="panel">
          <div class="row" style="justify-content:space-between;align-items:start">
            <div style="flex:1 1 420px">
              <div class="hint">Search multiple open-data catalogs at once. Then (optionally) scrape a specific page for downloadable files.</div>
              <div class="row" style="gap:8px;align-items:stretch;margin-top:8px">
                <input id="q" type="text" placeholder="e.g., pedestrian crashes Miami, hurricane tracks, LLM benchmarks" style="flex:1" />
                <select id="format">
                  <option value="">Any format</option>
                  <option value="csv">CSV</option>
                  <option value="json">JSON</option>
                  <option value="geojson">GeoJSON</option>
                  <option value="xlsx">XLSX/XLS</option>
                  <option value="zip">ZIP</option>
                  <option value="parquet">Parquet</option>
                </select>
                <button id="search" class="primary">Search datasets</button>
              </div>
              <div class="chips" style="margin-top:8px" id="source-chips"></div>
              <div class="row" style="gap:8px;margin-top:6px">
                <button id="select-all" class="chip">Select all</button>
                <button id="deselect-all" class="chip">Deselect all</button>
              </div>
            </div>
            <div class="panel" id="sources-panel" style="flex:1 1 260px">
              <div class="hint" style="margin-bottom:6px">Optional: paste a page URL to scan for direct dataset files (CSV, JSON, GeoJSON, XLSX, ZIP, Parquet).</div>
              <div class="row" style="gap:8px">
                <input id="scrape-url" type="url" placeholder="https://example.com/datasets" style="flex:1" />
                <button id="scrape" title="Scan page for downloadable file links">Scrape</button>
              </div>
            </div>
          </div>
        </div>
        <div class="panel">
          <div class="row" style="justify-content:space-between;align-items:center;flex-wrap:wrap">
            <div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
              <div class="hint">Sort & view</div>
              <select id="sort">
                <option value="relevance">Relevance</option>
                <option value="new">Newest first</option>
                <option value="old">Oldest first</option>
                <option value="az">Title A→Z</option>
              </select>
              <label class="chip" title="Show only records with direct file links (CSV, JSON, etc.)">
                <input type="checkbox" id="only-direct" /> direct downloads only
              </label>
              <label class="chip" title="Only include datasets updated/published after this date">
                Updated after
                <input type="date" id="updated-after" style="background:#0a0f21;color:var(--text);border:1px solid #223160;border-radius:8px;padding:6px 8px;margin-left:6px"/>
              </label>
            </div>
            <div class="hint"><span id="count">0</span> results</div>
          </div>
        </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="results" class="grid"></div>
    <div id="empty" class="empty hidden">No results yet. Try a broader query or select more sources.</div>
  </main>

  <script>
    // Public catalogs/APIs (CORS-friendly)
    const CATALOGS = {
      'Data.gov (US)': { id:'datagov', enabled:true },
      'data.gov.uk (UK)': { id:'datagovuk', enabled:false },
      'EU Open Data': { id:'euodp', enabled:false },
      'Socrata Catalog (many city/state portals)': { id:'socrata', enabled:true },
      'Zenodo (research repos)': { id:'zenodo', enabled:true },
      'Harvard Dataverse': { id:'dataverse', enabled:false },
      'Figshare': { id:'figshare', enabled:false },
      'World Bank (beta)': { id:'worldbank', enabled:false }
    };

    // Build source chips
    const chipsEl = document.getElementById('source-chips');
    Object.entries(CATALOGS).forEach(([name, obj]) => {
      const lab = document.createElement('label');
      lab.className = 'chip';
      lab.innerHTML = `<input type="checkbox" ${obj.enabled?'checked':''}/> <span>${name}</span>`;
      const cb = lab.querySelector('input');
      cb.addEventListener('change', ()=> obj.enabled = cb.checked);
      chipsEl.appendChild(lab);
    });

    document.getElementById('select-all').onclick = ()=>{
      Object.values(CATALOGS).forEach(o=>o.enabled=true);
      chipsEl.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=true);
    };
    document.getElementById('deselect-all').onclick = ()=>{
      Object.values(CATALOGS).forEach(o=>o.enabled=false);
      chipsEl.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false);
    };

    const state = { items: [], lastQ: '', lastFormat: '' };
    const el = (s)=>document.querySelector(s);

    function tag(str){ const t=document.createElement('span'); t.className='tag'; t.textContent=str; return t; }
    function showEmpty(show){ el('#empty').classList.toggle('hidden', !show); }
    function setCount(n){ el('#count').textContent = n; }

    function normalizeDate(d){ const t = Date.parse(d); return isNaN(t)?0:t; }

    function applyFiltersSort(items){
      const sort = el('#sort').value;
      const fmt = el('#format').value.trim().toLowerCase();
      const onlyDirect = !!document.getElementById('only-direct')?.checked;
      const updatedAfterStr = document.getElementById('updated-after')?.value || '';
      const updatedAfterTs = updatedAfterStr ? Date.parse(updatedAfterStr) : 0;

      let out = items;
      if (fmt){ out = out.filter(r => (r.formats||[]).some(f=> (f||'').toLowerCase().includes(fmt))); }
      if (onlyDirect){ out = out.filter(r => Array.isArray(r.files) && r.files.length > 0); }
      if (updatedAfterTs){ out = out.filter(r => normalizeDate(r.date) >= updatedAfterTs); }

      if (sort==='new') out.sort((a,b)=> normalizeDate(b.date)-normalizeDate(a.date));
      if (sort==='old') out.sort((a,b)=> normalizeDate(a.date)-normalizeDate(b.date));
      if (sort==='az') out.sort((a,b)=> a.title.localeCompare(b.title));
      return out;
    }

    function render(items){
      const results = el('#results');
      results.innerHTML = '';
      setCount(items.length);
      if (!items.length){ showEmpty(true); return; } else { showEmpty(false); }
      const frag = document.createDocumentFragment();
      items.forEach(it => {
        const card = document.createElement('article'); card.className = 'card';
        const c = document.createElement('div'); c.className='content';
        const meta = document.createElement('div'); meta.className = 'meta';
        meta.innerHTML = `<span>${it.source||''}</span><span>${it.date? new Date(it.date).toLocaleDateString():''}</span>`;
        const title = document.createElement('div'); title.className='title';
        title.innerHTML = `<a href="${it.link}" target="_blank" rel="noopener">${it.title||'Untitled dataset'}</a>`;
        const desc = document.createElement('div'); desc.className='desc';
        desc.textContent = (it.description||'').replace(/<[^>]+>/g,'').slice(0,260) + ((it.description||'').length>260?'…':'');
        const tags = document.createElement('div'); tags.className='tags';
        (it.formats||[]).slice(0,8).forEach(f=> tags.appendChild(tag(f)) );
        if (it.files && it.files.length){
          const filesRow = document.createElement('div'); filesRow.className='tags';
          it.files.slice(0,6).forEach(f=>{
            const a=document.createElement('a'); a.href=f.url; a.target='_blank'; a.rel='noopener'; a.className='tag'; a.textContent=f.label; filesRow.appendChild(a);
          });
          c.appendChild(filesRow);
        }
        c.appendChild(meta); c.appendChild(title); c.appendChild(desc); c.appendChild(tags);
        card.appendChild(c); frag.appendChild(card);
      });
      results.appendChild(frag);
    }

    // ---- Catalog searchers -----------------------------------------------
    async function fetchJSON(url){
      const r = await fetch(url);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }

    async function searchDataGov(q){
      const url = `https://catalog.data.gov/api/3/action/package_search?rows=50&q=${encodeURIComponent(q)}`;
      const data = await fetchJSON(url);
      const hits = data?.result?.results||[];
      return hits.map(x=>({
        title: x.title,
        description: x.notes,
        link: `https://catalog.data.gov/dataset/${x.name}`,
        date: x.metadata_modified,
        source: 'Data.gov',
        formats: (x.resources||[]).map(r=>r.format).filter(Boolean),
        files: (x.resources||[]).filter(r=>r.url).map(r=>({label:(r.name||r.format||'file'), url:r.url})),
        license: x.license_title || x.license_url || ''
      }));
    }

    async function searchDataGovUK(q){
      const url = `https://ckan.publishing.service.gov.uk/api/3/action/package_search?rows=50&q=${encodeURIComponent(q)}`;
      const data = await fetchJSON(url);
      const hits = data?.result?.results||[];
      return hits.map(x=>({
        title: x.title,
        description: x.notes,
        link: `https://ckan.publishing.service.gov.uk/dataset/${x.name}`,
        date: x.metadata_modified,
        source: 'data.gov.uk',
        formats: (x.resources||[]).map(r=>r.format).filter(Boolean),
        files: (x.resources||[]).filter(r=>r.url).map(r=>({label:(r.name||r.format||'file'), url:r.url})),
        license: x.license_title || x.license_url || ''
      }));
    }

    async function searchEUODP(q){
      const url = `https://data.europa.eu/api/hub/search/search?query=${encodeURIComponent(q)}&pageSize=50`;
      const data = await fetchJSON(url);
      const hits = data?.results || [];
      return hits.map(x=>{
        const d = x.distributions||[];
        const files = d.filter(z=>z.downloadURL).map(z=>({label:(z.title?.[0]?.value||z.format||'file'), url:z.downloadURL}));
        const fmts = Array.from(new Set(d.map(z=> (z.format||'').toUpperCase())));
        return {
          title: x.title?.[0]?.value || x.title || 'Dataset',
          description: x.description?.[0]?.value || x.description || '',
          link: x.landingPage || x.landingPageURL || x.id || '',
          date: x.issued || x.modified || '',
          source: 'EU Open Data',
          formats: fmts,
          files,
          license: (x.license?.title?.[0]?.value) || ''
        };
      });
    }

    async function searchDataverse(q){
      const url = `https://dataverse.harvard.edu/api/search?q=${encodeURIComponent(q)}&type=dataset&per_page=50`;
      const data = await fetchJSON(url);
      const hits = data?.data?.items || [];
      return hits.map(x=>({
        title: x.name,
        description: x.description,
        link: x.url,
        date: x.published_at || x.updated_at || '',
        source: 'Harvard Dataverse',
        formats: [],
        files: []
      }));
    }

    async function searchFigshare(q){
      const url = `https://api.figshare.com/v2/articles/search?search_for=${encodeURIComponent(q)}&page_size=50&item_type=dataset`;
      const data = await fetchJSON(url);
      const hits = Array.isArray(data) ? data : [];
      return hits.map(x=>{
        const files = (x.files||[]).map(f=>({label:f.name||f.supplied_md5||'file', url:f.download_url||f.supplied_url||x.url_public}));
        const fmts = Array.from(new Set(files.map(f=> (f.label.split('.').pop()||'').toUpperCase())));
        return {
          title: x.title,
          description: x.description,
          link: x.url_public || x.url,
          date: x.published_date || x.modified_date || '',
          source: 'Figshare',
          formats: fmts,
          files,
        };
      });
    }

    async function searchWorldBank(q){
      // world bank data catalog list, then simple client-side filter
      const url = `https://api.worldbank.org/v2/datacatalog?format=json`;
      const data = await fetchJSON(url);
      const items = data?.[1] || [];
      const qlc = q.toLowerCase();
      return items.filter(x=> !q || (x.Name?.toLowerCase().includes(qlc) || x.Description?.toLowerCase().includes(qlc)))
        .slice(0,50)
        .map(x=>({
          title: x.Name,
          description: x.Description,
          link: x.URL || x.AccessURL || 'https://datacatalog.worldbank.org/',
          date: x.Las tUpdateDate || '',
          source: 'World Bank (catalog)',
          formats: [],
          files: []
        }));
    }

    async function searchSocrata(q){
      const url = `https://api.us.socrata.com/api/catalog/v1?q=${encodeURIComponent(q)}&only=datasets&limit=50`;
      const data = await fetchJSON(url);
      const hits = data?.results||[];
      return hits.map(x=>{
        const res = x.resource||{}; const md = x.metadata||{}; const perm = x.permalink || res.permalink || '';
        const f = (res.classification && res.classification.domain_category) || 'Dataset';
        const fmts = new Set();
        (x.linked_resources||[]).forEach(lr=>{ if(lr.format) fmts.add(lr.format); });
        if (res.download_formats) Object.keys(res.download_formats).forEach(k=> fmts.add(k.toUpperCase()));
        return {
          title: res.name || md.name,
          description: res.description || md.description,
          link: perm || `https://${res.domain||''}/d/${res.id||''}`,
          date: md.updatedAt || md.createdAt,
          source: `Socrata: ${res.domain||''}`,
          formats: Array.from(fmts),
        };
      });
    }

    async function searchZenodo(q){
      const url = `https://zenodo.org/api/records?q=${encodeURIComponent(q)}&type=dataset&size=50&all_versions=false&sort=mostrecent`;
      const data = await fetchJSON(url);
      const hits = data?.hits?.hits||[];
      return hits.map(x=>{
        const files = (x.files||[]).map(f=>({label:f.key||f.filename, url:f.links?.self||f.links?.download}));
        const fmts = new Set(files.map(f=> (f.label.split('.').pop()||'').toUpperCase()));
        return {
          title: x.metadata?.title,
          description: x.metadata?.description,
          link: x.links?.html || x.links?.latest_html,
          date: x.metadata?.publication_date,
          source: 'Zenodo',
          formats: Array.from(fmts),
          files,
        };
      });
    }

    // --- Lightweight scraper ----------------------------------------------
    async function scrapePage(url){
      const prox = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
      const r = await fetch(prox);
      if (!r.ok) throw new Error('Failed to load page');
      const data = await r.json();
      const html = data.contents || '';
      // Find direct file links
      const REG = /(href|src)=["']([^"']+\.(?:csv|tsv|json|geojson|xlsx|xls|zip|parquet))(?:[?#][^"']*)?["']/gi;
      const out = new Map();
      let m; while((m = REG.exec(html))){
        try{
          const abs = new URL(m[2], url).toString();
          const label = abs.split('/').pop();
          out.set(abs, {label, url: abs});
        }catch{}
      }
      return [{
        title: `Links found on ${new URL(url).hostname}`,
        description: 'Direct file links detected on the page (best effort).',
        link: url,
        date: new Date().toISOString(),
        source: 'Scraper',
        formats: Array.from(new Set(Array.from(out.values()).map(o=> (o.label.split('.').pop()||'').toUpperCase()))),
        files: Array.from(out.values())
      }];
    }

    async function runSearch(){
      const q = el('#q').value.trim();
      const enabled = Object.values(CATALOGS).filter(c=>c.enabled).map(c=>c.id);
      if (!q && !enabled.length){ alert('Enter a query or enable at least one source.'); return; }
      el('#results').innerHTML = '<div class="empty">Searching…</div>';
      state.items = [];
      const tasks = [];
      if (enabled.includes('datagov')) tasks.push(searchDataGov(q).catch(()=>[]));
      if (enabled.includes('socrata')) tasks.push(searchSocrata(q).catch(()=>[]));
      if (enabled.includes('zenodo')) tasks.push(searchZenodo(q).catch(()=>[]));
      if (enabled.includes('datagovuk')) tasks.push(searchDataGovUK(q).catch(()=>[]));
      if (enabled.includes('euodp')) tasks.push(searchEUODP(q).catch(()=>[]));
      if (enabled.includes('dataverse')) tasks.push(searchDataverse(q).catch(()=>[]));
      if (enabled.includes('figshare')) tasks.push(searchFigshare(q).catch(()=>[]));
      if (enabled.includes('worldbank')) tasks.push(searchWorldBank(q).catch(()=>[]));
      const parts = await Promise.all(tasks);
      state.items = parts.flat();
      render(applyFiltersSort(state.items));
      window.scrollTo({top: document.querySelector('header').offsetHeight, behavior: 'smooth'});
    }

    // Events
    document.getElementById('search').addEventListener('click', runSearch);
    document.getElementById('q').addEventListener('keydown', e=>{ if(e.key==='Enter') runSearch(); });
    document.getElementById('sort').addEventListener('change', ()=> render(applyFiltersSort(state.items)) );
    document.getElementById('format').addEventListener('change', ()=> render(applyFiltersSort(state.items)) );
    const onlyDirectEl = document.getElementById('only-direct'); if (onlyDirectEl) onlyDirectEl.addEventListener('change', ()=> render(applyFiltersSort(state.items)) );
    const updatedAfterEl = document.getElementById('updated-after'); if (updatedAfterEl) updatedAfterEl.addEventListener('change', ()=> render(applyFiltersSort(state.items)) );
    document.getElementById('format').addEventListener('change', ()=> render(applyFiltersSort(state.items)) );
    document.getElementById('toggle-controls').addEventListener('click', ()=>{
      const c = document.getElementById('controls');
      c.classList.toggle('hidden');
      document.getElementById('toggle-controls').textContent = c.classList.contains('hidden') ? '▼ Show controls' : '▲ Hide controls';
    });
    document.getElementById('scrape').addEventListener('click', async ()=>{
      const url = el('#scrape-url').value.trim();
      if (!url) return alert('Paste a page URL to scrape');
      el('#results').innerHTML = '<div class="empty">Scanning page…</div>';
      try{
        const items = await scrapePage(url);
        state.items = items;
        render(items);
      }catch(err){
        console.error(err);
        el('#results').innerHTML = '<div class="empty">Could not read that page. Some sites block cross-origin access.</div>';
      }
    });

    // Initial hint
    showEmpty(true);
  </script>
</body>
</html>

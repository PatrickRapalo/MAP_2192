<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dataset & Web Extractor — Column Builder</title>
  <style>
    :root{--bg:#0b1020;--panel:#12182b;--text:#e7ecff;--muted:#a9b7ffcc;--chip:#1b2340;--card:#0f1527}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial,Noto Sans,sans-serif;background:linear-gradient(180deg,var(--bg),#070a14 40%);color:var(--text)}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(7,10,20,.95),rgba(7,10,20,.75));backdrop-filter:blur(6px);border-bottom:1px solid #1f2746}
    .container{max-width:1200px;margin:0 auto;padding:18px}
    h1{font-size:1.35rem;margin:0 0 10px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab{padding:8px 12px;border:1px solid #23315f;border-radius:999px;background:#0a0f21;color:var(--text);cursor:pointer}
    .tab.active{background:linear-gradient(180deg,#2a3c7d,#24356d);border-color:#2d3f80}
    .panel{background:var(--panel);border:1px solid #20294a;border-radius:14px;padding:12px}
    .grid{display:grid;gap:14px}
    @media(min-width:1000px){.grid-2{grid-template-columns:2fr 1fr}}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,button,textarea{padding:10px 12px;border-radius:10px;border:1px solid #223160;background:#0a0f21;color:var(--text)}
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,#2a3c7d,#24356d);border-color:#2d3f80}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:999px;background:var(--chip);border:1px solid #23315f;font-size:.92rem}
    .hint{color:var(--muted);font-size:.9rem}
    .card{background:var(--card);border:1px solid #1c2546;border-radius:16px;overflow:hidden}
    .content{padding:12px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #1a2240;padding:8px;text-align:left;vertical-align:top}
    .empty{text-align:center;padding:28px 10px;color:var(--muted)}
    .hidden{display:none!important}
    .scroll{max-height:60vh;overflow:auto;-webkit-overflow-scrolling:touch}
    .small{font-size:.9rem}
    .col-grid{display:grid;grid-template-columns:1.4fr 0.8fr 1fr 1fr auto;gap:8px;align-items:center}
    .col-grid input[type="text"]{width:100%}
    .kv{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Dataset & Web Extractor — Column Builder</h1>
      <div class="tabs">
        <button class="tab active" data-tab="extract">Extract From Web Page</button>
        <button class="tab" data-tab="datasets">Find Datasets</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- WEB EXTRACTOR (with column builder) -->
    <section id="tab-extract">
      <div class="grid grid-2">
        <div class="panel">
          <div class="hint">Load a public page, then define columns you want to extract. Each column = CSS selector + attribute + optional regex cleanup.</div>
          <div class="row" style="margin-top:8px">
            <input id="page-url" type="url" placeholder="https://example.com/articles" style="flex:1"/>
            <button id="load-page" class="primary">Load</button>
          </div>
          <div id="page-meta" class="small" style="margin-top:8px;color:var(--muted)"></div>

          <h3 style="margin:14px 0 6px">Column builder</h3>
          <div class="row small"><span class="hint">Tip: use the same container selector across columns to align rows (e.g., ".card").
            Set per-column selectors relative to each container (e.g., ".title a").</span></div>

          <div class="row" style="margin:6px 0">
            <input id="container-sel" placeholder="Container CSS (optional, e.g., .card)" style="flex:1"/>
            <button id="add-col" class="chip">+ Add column</button>
            <button id="clear-cols" class="chip">Clear</button>
            <div class="hint">Rows: <span id="ex-count">0</span></div>
          </div>

          <div id="cols" class="scroll"></div>

          <div class="row" style="justify-content:space-between;align-items:center;margin-top:8px">
            <div class="row" style="gap:8px">
              <label class="chip"><input type="checkbox" id="dedupe" checked/> deduplicate rows</label>
              <label class="chip"><input type="checkbox" id="absolute" checked/> make links absolute</label>
            </div>
            <div class="row" style="gap:8px">
              <button id="preset-blog" title="Title/URL/Date from typical article cards">Preset: Blog list</button>
              <button id="preset-table" title="Extract first table as columns">Preset: Table</button>
              <button id="run-cols" class="primary">Extract</button>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="hint">Preview (<span id="row-count">0</span> rows)</div>
            <div class="row" style="gap:8px">
              <button id="download-json">Download JSON</button>
              <button id="download-csv">Download CSV</button>
            </div>
          </div>
          <div class="scroll">
            <table class="table" id="ex-table"></table>
          </div>
        </div>
      </div>
    </section>

    <!-- DATASET FINDER (lite) -->
    <section id="tab-datasets" class="hidden">
      <div class="panel">
        <div class="hint">Quick dataset search across a few catalogs. For the full-featured finder you already have, keep using your other file.</div>
        <div class="row" style="margin-top:8px">
          <input id="q" style="flex:1" placeholder="e.g., traffic collisions, climate anomalies"/>
          <select id="format">
            <option value="">Any format</option>
            <option value="csv">CSV</option>
            <option value="json">JSON</option>
            <option value="geojson">GeoJSON</option>
            <option value="xlsx">XLSX/XLS</option>
            <option value="zip">ZIP</option>
            <option value="parquet">Parquet</option>
          </select>
          <button id="search" class="primary">Search</button>
        </div>
        <div id="source-chips" class="chips" style="margin-top:8px"></div>
        <div id="results" class="grid" style="margin-top:10px"></div>
        <div id="empty" class="empty hidden">No results yet.</div>
      </div>
    </section>
  </main>

  <script>
    // ------ tab switch
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(t=> t.addEventListener('click', ()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      document.getElementById('tab-extract').classList.toggle('hidden', t.dataset.tab!=='extract');
      document.getElementById('tab-datasets').classList.toggle('hidden', t.dataset.tab!=='datasets');
    }));

    // ===================== WEB EXTRACTOR with COLUMN BUILDER =====================
    let PAGE = { url:'', html:'', doc:null };
    const parser = new DOMParser();
    const el = s=>document.querySelector(s);

    function toAbs(url, base){ try{ return new URL(url, base).toString(); }catch{ return url; } }
    function download(filename, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'application/octet-stream'})); a.download=filename; a.click(); }
    function toCSV(rows){ if(!rows.length) return ''; const cols=[...new Set(rows.flatMap(r=>Object.keys(r)))]; const esc=v=>(''+(v??'')).replace(/"/g,'""'); return [cols.join(','), ...rows.map(r=> cols.map(c=>`"${esc(r[c])}"`).join(','))].join('\n'); }

    // dynamic column UI
    function colRow(def={name:'title', selector:'', attr:'text', regex:'', replace:'', required:false}){
      const wrap=document.createElement('div'); wrap.className='col-grid'; wrap.style.margin='6px 0';
      wrap.innerHTML = `
        <input type="text" class="col-name" placeholder="Column name" value="${def.name||''}"/>
        <input type="text" class="col-sel" placeholder="Selector (relative)" value="${def.selector||''}"/>
        <select class="col-attr">
          <option value="text" ${def.attr==='text'?'selected':''}>text</option>
          <option value="href" ${def.attr==='href'?'selected':''}>href</option>
          <option value="src" ${def.attr==='src'?'selected':''}>src</option>
          <option value="title" ${def.attr==='title'?'selected':''}>title</option>
          <option value="datetime" ${def.attr==='datetime'?'selected':''}>datetime</option>
          <option value="content" ${def.attr==='content'?'selected':''}>content</option>
          <option value="aria-label" ${def.attr==='aria-label'?'selected':''}>aria-label</option>
        </select>
        <input type="text" class="col-regex" placeholder="Regex (optional)" value="${def.regex||''}"/>
        <input type="text" class="col-repl" placeholder="Replace with" value="${def.replace||''}"/>
        <label class="chip" title="Drop row if this column is empty" style="justify-self:start"><input type="checkbox" class="col-req" ${def.required?'checked':''}/> required</label>
        <button class="chip col-del" title="Remove column">✖</button>
      `;
      wrap.querySelector('.col-del').onclick=()=> wrap.remove();
      return wrap;
    }

    function getCols(){
      const rows=[...document.querySelectorAll('#cols .col-grid')];
      return rows.map(r=>({
        name: r.querySelector('.col-name').value.trim()||'col',
        selector: r.querySelector('.col-sel').value.trim(),
        attr: r.querySelector('.col-attr').value,
        regex: r.querySelector('.col-regex').value,
        replace: r.querySelector('.col-repl').value,
        required: r.querySelector('.col-req').checked,
      }));
    }

    function renderCols(list){
      const box=el('#cols'); box.innerHTML='';
      list.forEach(d=> box.appendChild(colRow(d)));
      if(!list.length) box.appendChild(colRow());
    }

    function renderTable(rows){
      const table = document.getElementById('ex-table');
      table.innerHTML='';
      const countEl = document.getElementById('row-count');
      countEl.textContent = rows.length;
      if(!rows.length){ table.innerHTML='<tr><td class="empty">No rows</td></tr>'; return; }
      const cols = Array.from(new Set(rows.flatMap(r=>Object.keys(r))));
      const thead = `<thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead>`;
      const tbody = `<tbody>${rows.map(r=>`<tr>${cols.map(c=>`<td>${(r[c]??'').toString().replace(/[&<>]/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]))}</td>`).join('')}</tr>`).join('')}</tbody>`;
      table.innerHTML = thead + tbody;
    }

    async function loadPage(){
      const url = el('#page-url').value.trim(); if(!url) return alert('Enter a URL');
      el('#page-meta').textContent='Loading…';
      const prox=`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
      const r=await fetch(prox); if(!r.ok){ el('#page-meta').textContent='Failed to fetch (CORS/prerender blockers?)'; return; }
      const {contents=''}=await r.json();
      PAGE={url, html:contents, doc: parser.parseFromString(contents,'text/html')};
      const title = PAGE.doc.querySelector('title')?.textContent?.trim()||'(no title)';
      el('#page-meta').textContent = `Loaded: ${title}`;
    }

    function getText(n){ return (n.textContent||'').trim(); }
    function getAttr(n,attr){ return n.getAttribute(attr); }

    function applyRegex(str, rx, repl){
      if(!rx) return str;
      try{ const r=new RegExp(rx,'g'); return (str??'').toString().replace(r, repl??''); }catch{ return str; }
    }

    function extractColumns(){
      if(!PAGE.doc){ alert('Load a page first'); return []; }
      const abs = el('#absolute').checked;
      const containerSel = el('#container-sel').value.trim();
      const columns = getCols();
      let nodes = [];
      if(containerSel){ nodes = Array.from(PAGE.doc.querySelectorAll(containerSel)); }
      else {
        // If no container, derive from the first non-empty selector
        const first = columns.find(c=>c.selector);
        if(!first){ alert('Add at least one column with a selector'); return []; }
        nodes = Array.from(PAGE.doc.querySelectorAll(first.selector));
      }

      const rows = [];
      nodes.forEach(n => {
        const row = {};
        let drop = false;
        columns.forEach(c => {
          let target = n;
          if(containerSel && c.selector){ target = n.querySelector(c.selector); }
          else if(!containerSel && c.selector){ target = (c===columns[0]) ? n : n.closest('html').querySelector(c.selector); }
          let val = '';
          if(target){
            if(c.attr==='text') val = getText(target);
            else if(c.attr==='href' || c.attr==='src'){
              const raw = getAttr(target, c.attr);
              val = abs ? toAbs(raw, PAGE.url) : raw;
            } else {
              val = getAttr(target, c.attr);
            }
            val = applyRegex(val, c.regex, c.replace);
          }
          if(c.required && !val) drop = true;
          row[c.name] = val??'';
        });
        if(!drop) rows.push(row);
      });

      if(el('#dedupe').checked){
        const seen=new Set();
        return rows.filter(r=>{ const k=JSON.stringify(r); if(seen.has(k)) return false; seen.add(k); return true; });
      }
      return rows;
    }

    // presets
    function presetBlog(){
      el('#container-sel').value = '.card, article, .post';
      renderCols([
        {name:'title', selector:'.title, h2, h3 a', attr:'text'},
        {name:'url', selector:'a', attr:'href', required:true},
        {name:'date', selector:'time', attr:'datetime', regex:'T.*$', replace:''}
      ]);
    }
    function presetTable(){
      // Convert first table to column builder based on header cells
      if(!PAGE.doc){ alert('Load a page first'); return; }
      const t = PAGE.doc.querySelector('table');
      if(!t){ alert('No table found'); return; }
      el('#container-sel').value = 'table tbody tr, table tr';
      const headers = Array.from(t.querySelectorAll('thead th')).map(th=> th.textContent.trim())
        || Array.from(t.querySelectorAll('tr:first-child th, tr:first-child td')).map(td=> td.textContent.trim());
      const defs = (headers.length? headers: ['col_1','col_2','col_3']).map((h,i)=>({name: h||`col_${i+1}`, selector:`td:nth-child(${i+1}), th:nth-child(${i+1})`, attr:'text'}));
      renderCols(defs);
    }

    function runAndRender(){ const rows = extractColumns(); renderTable(rows); window._rows = rows; }

    // bind
    document.getElementById('load-page').addEventListener('click', loadPage);
    document.getElementById('add-col').addEventListener('click', ()=>{
      document.getElementById('cols').appendChild(colRow({name:'col'}));
    });
    document.getElementById('clear-cols').addEventListener('click', ()=> renderCols([]));
    document.getElementById('run-cols').addEventListener('click', runAndRender);
    document.getElementById('preset-blog').addEventListener('click', presetBlog);
    document.getElementById('preset-table').addEventListener('click', presetTable);

    document.getElementById('download-json').addEventListener('click', ()=> download('extracted.json', JSON.stringify(window._rows||[],null,2)));
    document.getElementById('download-csv').addEventListener('click', ()=> download('extracted.csv', toCSV(window._rows||[])));

    // init columns
    renderCols([]);

    // ===================== (Lite) DATASET FINDER =====================
    const CATALOGS = {
      'Data.gov (US)': { id:'datagov', enabled:true },
      'Socrata Catalog': { id:'socrata', enabled:true },
      'Zenodo': { id:'zenodo', enabled:true }
    };
    const chipsEl = document.getElementById('source-chips');
    if(chipsEl){
      Object.entries(CATALOGS).forEach(([name, obj])=>{
        const lab = document.createElement('label'); lab.className='chip';
        lab.innerHTML=`<input type="checkbox" ${obj.enabled?'checked':''}/> <span>${name}</span>`;
        const cb = lab.querySelector('input'); cb.addEventListener('change', ()=> obj.enabled = cb.checked);
        chipsEl.appendChild(lab);
      });
    }
    async function fetchJSON(url){ const r=await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
    const normalizeDate = d=>{const t=Date.parse(d);return isNaN(t)?0:t};
    function setDsCount(n){ /* optional */ }
    function renderDatasets(items){
      const results = document.getElementById('results'); if(!results) return;
      results.innerHTML=''; if(!items.length){ document.getElementById('empty').classList.remove('hidden'); return; } document.getElementById('empty').classList.add('hidden');
      const frag=document.createDocumentFragment();
      items.forEach(it=>{
        const art=document.createElement('article'); art.className='card';
        art.innerHTML=`<div class="content">
          <div class="meta"><span>${it.source||''}</span><span>${it.date?new Date(it.date).toLocaleDateString():''}</span></div>
          <div class="title"><a href="${it.link}" target="_blank" rel="noopener">${it.title||'Untitled dataset'}</a></div>
          <div class="desc">${(it.description||'').replace(/<[^>]+>/g,'').slice(0,260)}${(it.description||'').length>260?'…':''}</div>
        </div>`;
        frag.appendChild(art);
      }); results.appendChild(frag);
    }
    async function searchDataGov(q){ const u=`https://catalog.data.gov/api/3/action/package_search?rows=30&q=${encodeURIComponent(q)}`; const d=await fetchJSON(u); const hits=d?.result?.results||[]; return hits.map(x=>({title:x.title,description:x.notes,link:`https://catalog.data.gov/dataset/${x.name}`,date:x.metadata_modified,source:'Data.gov'})); }
    async function searchSocrata(q){ const u=`https://api.us.socrata.com/api/catalog/v1?q=${encodeURIComponent(q)}&only=datasets&limit=30`; const d=await fetchJSON(u); const hits=d?.results||[]; return hits.map(x=>{const r=x.resource||{}, m=x.metadata||{}; return {title:r.name||m.name, description:r.description||m.description, link:x.permalink||r.permalink||'', date:m.updatedAt||m.createdAt, source:`Socrata: ${r.domain||''}`};}); }
    async function searchZenodo(q){ const u=`https://zenodo.org/api/records?q=${encodeURIComponent(q)}&type=dataset&size=30&all_versions=false&sort=mostrecent`; const d=await fetchJSON(u); const hits=d?.hits?.hits||[]; return hits.map(x=>({title:x.metadata?.title, description:x.metadata?.description, link:x.links?.html||x.links?.latest_html, date:x.metadata?.publication_date, source:'Zenodo'})); }
    async function runSearch(){ const q=el('#q').value.trim(); const enabled=Object.values(CATALOGS).filter(c=>c.enabled).map(c=>c.id); if(!q||!enabled.length){ alert('Enter a query and enable at least one source.'); return; } const tasks=[]; if(enabled.includes('datagov'))tasks.push(searchDataGov(q)); if(enabled.includes('socrata'))tasks.push(searchSocrata(q)); if(enabled.includes('zenodo'))tasks.push(searchZenodo(q)); const parts=await Promise.allSettled(tasks); const merged=parts.flatMap(r=> r.value||[]); merged.sort((a,b)=> normalizeDate(b.date)-normalizeDate(a.date)); renderDatasets(merged); }
    const searchBtn = document.getElementById('search'); if(searchBtn){ searchBtn.addEventListener('click', runSearch); document.getElementById('q').addEventListener('keydown', e=>{ if(e.key==='Enter') runSearch(); }); }
  </script>
</body>
</html>

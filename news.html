<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Latest Tech & Science Headlines — Infinite Scroll</title>
  <style>
    :root{--bg:#0c1022;--panel:#121831;--card:#0f162c;--text:#e9ecff;--muted:#a9b7ffcc;--chip:#1a2344;--accent:#7aa2ff}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,var(--bg),#090f1e 45%);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(9,15,30,.95),rgba(9,15,30,.75));backdrop-filter:blur(6px);border-bottom:1px solid #1f2b55}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    h1{font-size:1.35rem;margin:0}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .panel{background:var(--panel);border:1px solid #1b2550;border-radius:14px;padding:12px}
    input,select,button{padding:10px 12px;border-radius:10px;border:1px solid #233160;background:#0a0f21;color:var(--text)}
    button.primary{background:linear-gradient(180deg,#2a3c7d,#24356d);border-color:#2d3f80;cursor:pointer}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:7px 10px;border-radius:999px;background:var(--chip);border:1px solid #23315f;font-size:.92rem}
    .grid{display:grid;gap:14px}
    @media(min-width:980px){.grid-2{grid-template-columns:2fr 1fr}}
    .card{background:var(--card);border:1px solid #1b254e;border-radius:16px;overflow:hidden}
    .content{padding:14px}
    .title a{color:var(--text);text-decoration:none;font-weight:700}
    .title a:hover{text-decoration:underline}
    .meta{display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:.86rem;margin-bottom:6px}
    .badge{display:inline-flex;align-items:center;padding:2px 8px;border:1px solid #2b3a77;border-radius:999px;background:#0d1530;color:#bcd0ff;font-size:.78rem}
    .empty{text-align:center;padding:26px 10px;color:var(--muted)}
    .hidden{display:none!important}
    /* sources panel should not stretch with articles column */
    aside.panel{max-height:80vh;overflow-y:auto;position:sticky;top:96px;align-self:flex-start}
    /* skeletons */
    .skeleton{height:120px;border-radius:16px;background:#0e1531;border:1px solid #1b254e;position:relative;overflow:hidden}
    .skeleton::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);animation:shimmer 1.1s infinite}
    @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Latest Tech & Science Headlines</h1>
    </div>
  </header>

  <main class="container grid grid-2" style="margin-top:12px">
    <!-- LEFT: controls + results -->
    <section>
      <div class="panel">
        <div class="row" style="align-items:flex-start;justify-content:space-between">
          <div class="row" style="flex:1;gap:10px">
            <label class="chip"><input type="checkbox" class="cat" data-cat="ai" checked> AI</label>
            <label class="chip"><input type="checkbox" class="cat" data-cat="science" checked> Science + Data Science</label>
            <label class="chip"><input type="checkbox" class="cat" data-cat="tech" checked> Tech</label>
            <input id="q" placeholder="Filter by keyword (e.g., quantum, fusion, LLM)" style="flex:1;min-width:240px"/>
            <select id="sort">
              <option value="new">Newest first</option>
              <option value="old">Oldest first</option>
              <option value="az">Title A→Z</option>
            </select>
            <select id="fresh">
              <option value="30">Last 30 days</option>
              <option value="90" selected>Last 90 days</option>
              <option value="180">Last 180 days</option>
              <option value="365">Last 365 days</option>
            </select>
            <button id="fetch" class="primary">Fetch</button>
            <button id="toggle-sources">Hide controls</button>
          </div>
        </div>
        <div class="small" id="fresh-note" style="margin-top:6px;color:var(--muted)">Showing last 90 days only. Use keyword filter to narrow.</div>
      </div>

      <div id="count" class="small" style="margin:10px 0;color:var(--muted)">0 results</div>

      <div id="results" class="grid"></div>
      <div id="empty" class="empty">No results yet. Click <em>Fetch</em> to load headlines.</div>
      <div id="infinite-sentinel" style="height:2px"></div>
    </section>

    <!-- RIGHT: sources -->
    <aside class="panel">
      <div class="row" style="justify-content:space-between;align-items:center">
        <strong>Sources</strong>
        <div class="row">
          <button id="select-all" class="chip">Select all</button>
          <button id="deselect-all" class="chip">Deselect all</button>
        </div>
      </div>
      <div id="sources" style="margin-top:8px"></div>
      <div class="small" style="margin-top:8px;color:var(--muted)">Tip: toggle categories above to quickly include/exclude whole groups.</div>
    </aside>
  </main>

  <script>
    // ---------------------- Config: sources by category (RSS/Atom) ----------------------
    const CATALOG = {
      ai: {
        label: 'AI', color: '#7aa2ff', feeds: {
          'OpenAI Blog': 'https://openai.com/blog/rss.xml',
          'Google AI Blog': 'https://ai.googleblog.com/atom.xml',
          'ArXiv cs.AI (recent)': 'https://export.arxiv.org/rss/cs.AI',
          'MIT News – AI': 'http://news.mit.edu/topic/artificial-intelligence2-rss.xml',
          'VentureBeat AI': 'https://venturebeat.com/category/ai/feed/'
        }
      },
      science: {
        label: 'Science + Data Science', color: '#98e6a6', feeds: {
          'NASA Breaking News': 'https://www.nasa.gov/rss/dyn/breaking_news.rss',
          'Nature – News': 'https://www.nature.com/nature/articles?type=news.rss',
          'ScienceDaily – Top Science': 'https://www.sciencedaily.com/rss/top/science.xml',
          'NOAA News': 'https://www.noaa.gov/rss.xml',
          'Phys.org – Top News': 'https://phys.org/rss-feed/',
          'KDnuggets': 'https://www.kdnuggets.com/feed',
          'Towards Data Science (tag feed)': 'https://medium.com/feed/tag/data-science',
          'Analytics Vidhya': 'https://www.analyticsvidhya.com/blog/feed/',
          'DataTau': 'https://www.datatau.com/rss',
          'Kaggle Blog (mirror)': 'https://feeds.feedburner.com/kaggle-blog'
        }
      },
      tech: {
        label: 'Tech', color: '#f3c17a', feeds: {
          'TechCrunch': 'https://techcrunch.com/feed/',
          'The Verge – Tech': 'https://www.theverge.com/tech/rss/index.xml',
          'Ars Technica': 'https://arstechnica.com/feed/',
          'Wired': 'https://www.wired.com/feed/rss',
          'IEEE Spectrum': 'https://spectrum.ieee.org/rss'
        }
      }
    };

    // ---------------------- Helpers ----------------------
    let FRESH_DAYS = 90;              // default freshness window
    const PAGE_SIZE = 50;             // articles per page append
    let ALL_ITEMS = [];               // merged + filtered
    let VISIBLE = 0;                  // rendered count
    let LOADING_MORE = false;

    // Incremental run state
    let RUN = 0;                      // monotonic run id for cancelation
    const SEEN_KEYS = new Set();      // dedupe across feeds
    let PENDING_TO_RENDER = [];       // buffer to batch DOM inserts
    let IS_STREAMING = false;
    const INSERT_BATCH = 10;
    let renderDrainScheduled = false;

    const el = s=> document.querySelector(s);
    const norm = d=>{ const t=Date.parse(d||''); return Number.isNaN(t)?0:t; };
    const cutoff = ()=>{ const d=new Date(); d.setDate(d.getDate()-FRESH_DAYS); return d.getTime(); };
    const isFresh = it=> norm(it.date) >= cutoff();

    function fmtDate(d){ const t=norm(d); return t? new Date(t).toLocaleString():''; }
    function setCount(n){ el('#count').textContent = `${n} result${n===1?'':'s'}`; }

    function makeSourceList(){
      const box = el('#sources');
      box.innerHTML = '';
      Object.entries(CATALOG).forEach(([cat, group])=>{
        const h = document.createElement('div');
        h.innerHTML = `<div class="row" style="justify-content:space-between;align-items:center;margin:6px 0">
            <span class="badge" style="border-color:${group.color};">${group.label}</span>
            <label class="chip"><input type="checkbox" class="cat" data-cat="${cat}" checked> include</label>
          </div>`;
        box.appendChild(h);
        Object.entries(group.feeds).forEach(([name,url])=>{
          const lab = document.createElement('label');
          lab.className = 'chip'; lab.style.display='inline-flex'; lab.style.userSelect='none';
          lab.innerHTML = `<input type="checkbox" class="src" data-cat="${cat}" data-url="${url}" checked> ${name}`;
          box.appendChild(lab);
        });
      });
    }

    function setCatTogglesFromHeader(){
      document.querySelectorAll('input.cat').forEach(cb=>{
        cb.addEventListener('change', ()=>{
          const cat = cb.getAttribute('data-cat');
          document.querySelectorAll(`input.src[data-cat="${cat}"]`).forEach(scb=> scb.checked = cb.checked);
        });
      });
    }

    function selectAll(v){ document.querySelectorAll('input.src').forEach(cb=> cb.checked = v); }

    // ---------------------- Fetching feeds w/ fallback proxy ----------------------
    async function fetchAllOrigins(url){
      const r = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
      if(!r.ok) throw new Error('HTTP '+r.status);
      const {contents=''} = await r.json();
      return contents;
    }

    async function fetchRss2Json(url){
      const r = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`);
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }

    function parseFeedXML(xml, source){
      const doc = new DOMParser().parseFromString(xml, 'text/xml');
      const items = [...doc.querySelectorAll('item')];
      const entries = items.length? items: [...doc.querySelectorAll('entry')];
      return entries.map(n=>{
        const get = sel => n.querySelector(sel)?.textContent?.trim();
        const title = get('title') || '(untitled)';
        const link = n.querySelector('link')?.getAttribute('href') || get('link');
        const date = get('pubDate') || get('published') || get('updated') || get('dc\\:date');
        const desc = get('description') || get('summary') || '';
        return { title, link, date, description: desc, source };
      });
    }

    function parseFeedRss2Json(json, source){
      const items = json?.items || [];
      return items.map(it=>({
        title: it.title || '(untitled)',
        link: it.link || it.guid || '',
        date: it.pubDate || it.published || it.updated || '',
        description: (it.description || it.content || '').toString(),
        source
      }));
    }

    async function fetchOneFeed(url, name){
      try{
        const xml = await fetchAllOrigins(url);
        const parsed = parseFeedXML(xml, name);
        if(parsed && parsed.length) return parsed;
      }catch{}
      try{
        const js = await fetchRss2Json(url);
        const parsed = parseFeedRss2Json(js, name);
        return parsed;
      }catch{ return []; }
    }

    // ---------------------- Incremental rendering ----------------------
    function queueRender(items){
      hideSkeletons();
      PENDING_TO_RENDER.push(...items);
      if (!renderDrainScheduled) {
        renderDrainScheduled = true;
        requestAnimationFrame(drainRenderQueue);
      }
    }

    function drainRenderQueue(){
      renderDrainScheduled = false;
      const container = el('#results');
      const frag = document.createDocumentFragment();
      let count = 0;

      while (PENDING_TO_RENDER.length && count < INSERT_BATCH){
        const it = PENDING_TO_RENDER.shift();
        const art = document.createElement('article');
        art.className = 'card';
        art.innerHTML = `<div class="content">
            <div class="meta"><span>${it.source||''}</span><span>${fmtDate(it.date)}</span></div>
            <div class="title"><a href="${it.link}" target="_blank" rel="noopener">${it.title}</a></div>
            ${it.description? `<p class="small" style="opacity:.92;margin:6px 0">${it.description.replace(/<[^>]+>/g,'').slice(0,240)}${it.description.length>240?'…':''}</p>`:''}
            <div class="chips"><span class="badge">${it.cat||''}</span></div>
          </div>`;
        frag.appendChild(art);
        count++;
        VISIBLE++;
      }
      container.appendChild(frag);

      if (PENDING_TO_RENDER.length){
        requestAnimationFrame(drainRenderQueue);
      } else {
        toggleSentinel();
      }
    }

    // ---------------------- Concurrency helper ----------------------
    async function poolMap(concurrency, tasks, worker){
      const out = [];
      let i = 0;
      await Promise.all(Array.from({length: concurrency}, async () => {
        while (i < tasks.length){
          const idx = i++;
          out[idx] = await worker(tasks[idx], idx);
        }
      }));
      return out;
    }

    // ---------------------- NEW incremental loader ----------------------
    async function loadSelectedFeedsIncremental(activeRun){
      const enabled = [...document.querySelectorAll('input.src:checked')]
        .map(x => ({ url: x.dataset.url, cat: x.dataset.cat, name: x.parentElement.textContent.trim() }));

      if (!enabled.length){ alert('Select at least one source.'); return; }

      SEEN_KEYS.clear();

      await poolMap(4, enabled, async ({url, cat, name}) => {
        if (RUN !== activeRun) return;
        let items = await fetchOneFeed(url, name);
        if (RUN !== activeRun) return;

        items = items.map(it => ({ ...it, cat })).filter(isFresh);

        const kw = el('#q').value.trim().toLowerCase();
        if (kw){
          items = items.filter(it => (it.title + " " + (it.description||'')).toLowerCase().includes(kw));
        }

        const fresh = [];
        for (const it of items){
          const key = (it.link||it.title||'').trim();
          if (!key || SEEN_KEYS.has(key)) continue;
          SEEN_KEYS.add(key);
          fresh.push(it);
        }

        const sort = el('#sort').value;
        if (sort==='new') fresh.sort((a,b)=> norm(b.date)-norm(a.date));
        if (sort==='old') fresh.sort((a,b)=> norm(a.date)-norm(b.date));
        if (sort==='az')  fresh.sort((a,b)=> (a.title||'').localeCompare(b.title||''));

        ALL_ITEMS.push(...fresh);
        if (sort==='new') ALL_ITEMS.sort((a,b)=> norm(b.date)-norm(a.date));
        if (sort==='old') ALL_ITEMS.sort((a,b)=> norm(a.date)-norm(b.date));
        if (sort==='az')  ALL_ITEMS.sort((a,b)=> (a.title||'').localeCompare(b.title||''));

        setCount(ALL_ITEMS.length);
        queueRender(fresh);
      });
    }

    // ---------------------- Your existing infinite scroll (kept) ----------------------
    function clearResults(){ el('#results').innerHTML=''; VISIBLE=0; }

    function renderNextPage(){
      const container = el('#results');
      const end = Math.min(VISIBLE + PAGE_SIZE, ALL_ITEMS.length);
      const batch = ALL_ITEMS.slice(VISIBLE, end);
      const frag = document.createDocumentFragment();
      batch.forEach(it=>{
        const art = document.createElement('article');
        art.className = 'card';
        art.innerHTML = `<div class="content">
            <div class="meta"><span>${it.source||''}</span><span>${fmtDate(it.date)}</span></div>
            <div class="title"><a href="${it.link}" target="_blank" rel="noopener">${it.title}</a></div>
            ${it.description? `<p class="small" style="opacity:.92;margin:6px 0">${it.description.replace(/<[^>]+>/g,'').slice(0,240)}${it.description.length>240?'…':''}</p>`:''}
            <div class="chips"><span class="badge">${it.cat||''}</span></div>
          </div>`;
        frag.appendChild(art);
      });
      container.appendChild(frag);
      VISIBLE = end;
      setCount(ALL_ITEMS.length);
      toggleSentinel();
    }

    const sentinel = el('#infinite-sentinel');
    function toggleSentinel(){ sentinel.style.display = VISIBLE>=ALL_ITEMS.length? 'none':'block'; }

    const io = new IntersectionObserver(entries=>{
      if(!entries[0].isIntersecting) return;
      if(LOADING_MORE) return;
      if(VISIBLE>=ALL_ITEMS.length) return;
      LOADING_MORE = true;
      requestAnimationFrame(()=>{ renderNextPage(); LOADING_MORE=false; });
    }, { rootMargin:'600px 0px 600px 0px' });
    io.observe(sentinel);

    // ---------------------- Skeletons ----------------------
    function showSkeletons(n=8){
      const r = el('#results');
      r.innerHTML = '';
      const frag = document.createDocumentFragment();
      for(let i=0;i<n;i++){ const d=document.createElement('div'); d.className='skeleton'; frag.appendChild(d); }
      r.appendChild(frag);
    }
    function hideSkeletons(){
      el('#results').querySelectorAll('.skeleton').forEach(n=>n.remove());
    }

    // ---------------------- Events ----------------------
    async function runFetch(){
      // cancel any previous run
      RUN++; const myRun = RUN;
      IS_STREAMING = true;
      PENDING_TO_RENDER = [];
      VISIBLE = 0;
      ALL_ITEMS = [];
      setCount(0);
      el('#empty').classList.add('hidden');
      showSkeletons(10);
      toggleSentinel();

      // slight delay so skeletons paint
      await new Promise(r => setTimeout(r, 30));
      if (RUN !== myRun) return;

      try{
        await loadSelectedFeedsIncremental(myRun);
      }catch(e){
        if (RUN !== myRun) return;
        console.error(e);
        el('#results').innerHTML = '<div class="empty">Error fetching some feeds. Try again.</div>';
      }finally{
        if (RUN !== myRun) return;
        IS_STREAMING = false;
        hideSkeletons();
        if (!ALL_ITEMS.length){
          el('#results').innerHTML = '';
          el('#empty').classList.remove('hidden');
        }
      }
    }

    document.getElementById('fetch').addEventListener('click', runFetch);
    document.getElementById('q').addEventListener('keydown', e=>{ if(e.key==='Enter') runFetch(); });

    document.getElementById('sort').addEventListener('change', ()=>{
      if (ALL_ITEMS.length){
        const sort = el('#sort').value;
        if (sort==='new') ALL_ITEMS.sort((a,b)=> norm(b.date)-norm(a.date));
        if (sort==='old') ALL_ITEMS.sort((a,b)=> norm(a.date)-norm(b.date));
        if (sort==='az')  ALL_ITEMS.sort((a,b)=> (a.title||'').localeCompare(b.title||''));
        // Optional: clear + full re-render; disabled to avoid reordering already-visible cards
        // clearResults(); renderNextPage();
      }
    });

    document.getElementById('fresh').addEventListener('change', (e)=>{
      FRESH_DAYS = parseInt(e.target.value,10)||90;
      el('#fresh-note').textContent = `Showing last ${FRESH_DAYS} days only. Use keyword filter to narrow.`;
      runFetch(); // re-run to apply freshness at source
    });

    document.getElementById('select-all').addEventListener('click', ()=> selectAll(true));
    document.getElementById('deselect-all').addEventListener('click', ()=> selectAll(false));
    document.getElementById('toggle-sources').addEventListener('click', ()=>{
      const aside = document.querySelector('aside.panel');
      const btn = document.getElementById('toggle-sources');
      const hidden = aside.classList.toggle('hidden');
      btn.textContent = hidden? 'Show controls':'Hide controls';
    });

    // init
    makeSourceList();
    setCatTogglesFromHeader();
  </script>
</body>
</html>

<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Box Finder (OCR)</title>
  <style>
    body { margin:0; font-family:system-ui, sans-serif; background:#0b1020; color:#eaf }
    header { padding:10px 14px; position:sticky; top:0; background:#0b1020e6; backdrop-filter:blur(4px) }
    #wrap { display:grid; grid-template-columns:1fr 320px; gap:12px; padding:12px }
    #view { position:relative }
    video, canvas { width:100%; height:auto; display:block; border-radius:8px }
    #overlay { position:absolute; inset:0; pointer-events:none }
    aside { font-size:14px }
    .muted { color:#a9b }
    #log { height:160px; overflow:auto; background:#0f1430; border:1px solid #27305f; padding:8px; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px }
    button, input, select { font:inherit }
  </style>
</head>
<body>
<header>
  <strong>Box Finder</strong>
  <span id="status" class="muted">loading…</span>
</header>

<div id="wrap">
  <div id="view">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
  </div>

  <aside>
    <div style="margin-bottom:8px">
      <label>Target text: </label>
      <input id="query" value="6539" size="10">
      <button id="snap">Recognize now</button>
    </div>
    <div style="margin-bottom:8px">
      <label>Refresh rate: </label>
      <select id="rate">
        <option value="1500">Every 1.5s</option>
        <option value="1000" selected>Every 1s</option>
        <option value="500">Every 0.5s</option>
        <option value="0">Manual only</option>
      </select>
      <label style="margin-left:10px"><input type="checkbox" id="showAll" checked> show all OCR boxes</label>
    </div>
    <div id="log" class="muted"></div>
    <p class="muted">Tip: good lighting, hold steady, keep labels upright.</p>
  </aside>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.5/dist/tesseract.min.js"></script>
<script>
const video   = document.getElementById('video');
const overlay = document.getElementById('overlay');
const ctx     = overlay.getContext('2d');
const statusEl= document.getElementById('status');
const queryEl = document.getElementById('query');
const rateEl  = document.getElementById('rate');
const snapBtn = document.getElementById('snap');
const showAll = document.getElementById('showAll');
const logEl   = document.getElementById('log');
function log(m){ console.log(m); logEl.textContent = (m+"\n"+logEl.textContent).slice(0,8000); }

let worker=null, timer=null, busy=false, scale=0.9;

function sizeCanvas(){ if (!video.videoWidth) return; overlay.width=video.videoWidth; overlay.height=video.videoHeight; }

async function initCamera(){
  try{
    video.muted = true; // iOS autoplay
    const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
    video.srcObject = stream; await video.play(); sizeCanvas();
    video.addEventListener('loadedmetadata', sizeCanvas); window.addEventListener('resize', sizeCanvas);
    log('Camera ready.');
  }catch(e){ statusEl.textContent='camera error'; log('Camera error: '+e); }
}

async function initOCR(){
  try{
    statusEl.textContent='loading OCR…';
    worker = await Tesseract.createWorker({
      // Pin all paths (prevents “stuck loading” on GH Pages)
      workerPath: 'https://cdn.jsdelivr.net/npm/tesseract.js@5.0.5/dist/worker.min.js',
      corePath:   'https://cdn.jsdelivr.net/npm/tesseract.js-core@5.0.0/tesseract-core.wasm.js',
      wasmPath:   'https://cdn.jsdelivr.net/npm/tesseract.js-core@5.0.0/tesseract-core.wasm',
      langPath:   'https://tessdata.projectnaptha.com/4.0.0',
      logger: m => { statusEl.textContent = m.status + (m.progress?` ${(m.progress*100|0)}%`:'' ); }
    });
    log('worker created');
    await worker.load();                 log('worker.load() done');
    await worker.loadLanguage('eng');    log('worker.loadLanguage(eng) done');
    await worker.initialize('eng');      log('worker.initialize(eng) done');
    await worker.setParameters({
      tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ-',
      preserve_interword_spaces:'1',
      user_defined_dpi:'240',
      tessedit_pageseg_mode:'6'
    });
    statusEl.textContent='ready'; log('OCR ready.');
  }catch(e){ statusEl.textContent='ocr error'; log('OCR error: '+e); }
}

function scheduleLoop(){ if (timer) clearInterval(timer); const ms=+rateEl.value; if (ms>0) timer=setInterval(()=>recognizeFrame(), ms); }

async function recognizeFrame(){
  if (busy || !worker || !video.videoWidth) return;
  busy=true;
  try{
    const w=Math.max(320, Math.floor(overlay.width*scale)), h=Math.max(240, Math.floor(overlay.height*scale));
    const tmp=document.createElement('canvas'); tmp.width=w; tmp.height=h;
    const tctx=tmp.getContext('2d',{willReadFrequently:true});
    tctx.drawImage(video,0,0,w,h);
    const img=tctx.getImageData(0,0,w,h), d=img.data;
    for(let i=0;i<d.length;i+=4){ const g=(d[i]*.3+d[i+1]*.59+d[i+2]*.11)|0; const c=Math.min(255,Math.max(0,(g-120)*1.25+120)); d[i]=d[i+1]=d[i+2]=c; }
    tctx.putImageData(img,0,0);

    statusEl.textContent='recognizing…';
    const { data } = await worker.recognize(tmp);
    drawBoxes(data);
    const plain=(data.text||'').replace(/\s+/g,' ').trim(); if (plain) log('OCR: '+plain.slice(0,160));
    statusEl.textContent='ready';
  }catch(e){ statusEl.textContent='recognize error'; log('recognize error: '+e); }
  finally{ busy=false; }
}

function drawBoxes(data){
  const q=(queryEl.value||'').trim().toUpperCase();
  ctx.clearRect(0,0,overlay.width,overlay.height);
  const s=1/scale; let hits=0;

  if (showAll.checked){
    ctx.lineWidth=2; ctx.strokeStyle='rgba(200,200,220,0.6)';
    for(const w of (data.words||[])){ const b=w.bbox; ctx.strokeRect(b.x0*s,b.y0*s,(b.x1-b.x0)*s,(b.y1-b.y0)*s); }
  }
  if (q){
    ctx.lineWidth=4; ctx.strokeStyle='#4cff4c'; ctx.fillStyle='rgba(76,255,76,0.25)';
    for(const w of (data.words||[])){
      const t=(w.text||'').toUpperCase();
      if (t.includes(q)){ const b=w.bbox; ctx.fillRect(b.x0*s,b.y0*s,(b.x1-b.x0)*s,(b.y1-b.y0)*s); ctx.strokeRect(b.x0*s,b.y0*s,(b.x1-b.x0)*s,(b.y1-b.y0)*s); hits++; }
    }
  }
  ctx.fillStyle='#eaf'; ctx.font='18px system-ui';
  ctx.fillText(q?`Looking for "${q}" — matches: ${hits}`:'Enter a target and press Recognize',12,24);
}

snapBtn.onclick=recognizeFrame; rateEl.onchange=scheduleLoop; queryEl.onchange=recognizeFrame;

(async()=>{ await initCamera(); await initOCR(); scheduleLoop(); })();
</script>
</body>
</html>

<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Box Finder — Offline (PWA)</title>
<meta name="theme-color" content="#0b1020" />
<style>
  :root{--bg:#0b1020;--muted:#a9b}
  body{margin:0;background:var(--bg);color:#eaf;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{padding:10px 14px;position:sticky;top:0;background:#0b1020e6;backdrop-filter:blur(4px);z-index:2}
  #wrap{display:grid;grid-template-columns:1fr 320px;gap:12px;padding:12px}
  #view{position:relative}
  video,canvas{width:100%;height:auto;display:block;border-radius:8px;background:#000}
  #overlay{position:absolute;inset:0;pointer-events:none}
  aside{font-size:14px}
  input,button,select{font:inherit}
  .muted{color:var(--muted)}
  #log{height:160px;overflow:auto;background:#0f1430;border:1px solid #27305f;padding:8px;border-radius:6px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;white-space:pre-wrap}
  .pill{display:inline-block;padding:2px 8px;border:1px solid #3a4;border-radius:999px;margin-left:8px;font-size:12px}
</style>
</head>
<body>
<header>
  <strong>Box Finder</strong>
  <span id="status" class="muted">loading…</span>
  <span id="pwa" class="pill">PWA</span>
</header>

<div id="wrap">
  <div id="view">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
  </div>

  <aside>
    <div style="margin-bottom:8px">
      <label>Target text: </label>
      <input id="query" value="6539" size="10">
      <button id="snap">Recognize now</button>
    </div>
    <div style="margin-bottom:8px">
      <label>Refresh rate: </label>
      <select id="rate">
        <option value="1500">Every 1.5s</option>
        <option value="1000" selected>Every 1s</option>
        <option value="500">Every 0.5s</option>
        <option value="0">Manual only</option>
      </select>
      <label style="margin-left:10px"><input type="checkbox" id="showAll" checked> show all OCR boxes</label>
    </div>
    <div id="log" class="muted"></div>
    <p class="muted">Tip: good lighting, hold steady, keep labels upright.</p>
  </aside>
</div>

<!-- Use stable v4 Tesseract.js -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
<script>
const video   = document.getElementById('video');
const overlay = document.getElementById('overlay');
const ctx     = overlay.getContext('2d');
const statusEl= document.getElementById('status');
const queryEl = document.getElementById('query');
const rateEl  = document.getElementById('rate');
const snapBtn = document.getElementById('snap');
const showAll = document.getElementById('showAll');
const logEl   = document.getElementById('log');

let timer=null, busy=false, scale=0.9;
function log(m){ console.log(m); logEl.textContent=(m+"\n"+logEl.textContent).slice(0,8000); }

function sizeCanvas(){ if(!video.videoWidth) return; overlay.width=video.videoWidth; overlay.height=video.videoHeight; }

async function initCamera(){
  try{
    video.muted = true; 
    const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
    video.srcObject = stream; await video.play();
    sizeCanvas(); video.addEventListener('loadedmetadata', sizeCanvas); window.addEventListener('resize', sizeCanvas);
    log('Camera ready.');
    statusEl.textContent='ready';
  }catch(e){ statusEl.textContent='camera error'; log('Camera error: '+e.message); }
}

function scheduleLoop(){ if(timer) clearInterval(timer); const ms=+rateEl.value; if(ms>0) timer=setInterval(()=>recognizeFrame(), ms); }

async function recognizeFrame(){
  if(busy || !video.videoWidth) return;
  busy = true;
  try{
    const w=Math.max(320, Math.floor(overlay.width*scale));
    const h=Math.max(240, Math.floor(overlay.height*scale));
    const tmp=document.createElement('canvas'); tmp.width=w; tmp.height=h;
    const tctx=tmp.getContext('2d',{willReadFrequently:true});

    tctx.drawImage(video,0,0,w,h);
    const img=tctx.getImageData(0,0,w,h); const d=img.data;
    for(let i=0;i<d.length;i+=4){ const g=(d[i]*.3+d[i+1]*.59+d[i+2]*.11)|0; const c=Math.min(255,Math.max(0,(g-120)*1.25+120)); d[i]=d[i+1]=d[i+2]=c; }
    tctx.putImageData(img,0,0);

    statusEl.textContent='recognizing…';
    const result = await Tesseract.recognize(tmp, 'eng', {
      logger: m => statusEl.textContent = m.status + (m.progress?` ${(m.progress*100|0)}%`:'')
    });

    drawBoxes(result.data);
    const plain=(result.data.text||'').replace(/\s+/g,' ').trim();
    if(plain) log('OCR: '+plain.slice(0,160));
    statusEl.textContent='ready';
  }catch(e){ statusEl.textContent='recognize error'; log('recognize error: '+e.message); }
  finally{ busy=false; }
}

function drawBoxes(data){
  const q=(queryEl.value||'').trim().toUpperCase();
  ctx.clearRect(0,0,overlay.width,overlay.height);
  const s=1/scale; let hits=0;

  if(showAll.checked){
    ctx.lineWidth=2; ctx.strokeStyle='rgba(200,200,220,0.6)';
    for(const w of (data.words||[])){ const b=w.bbox; ctx.strokeRect(b.x0*s,b.y0*s,(b.x1-b.x0)*s,(b.y1-b.y0)*s); }
  }
  if(q){
    ctx.lineWidth=4; ctx.strokeStyle='#4cff4c'; ctx.fillStyle='rgba(76,255,76,0.25)';
    for(const w of (data.words||[])){
      const t=(w.text||'').toUpperCase();
      if(t.includes(q)){ const b=w.bbox; ctx.fillRect(b.x0*s,b.y0*s,(b.x1-b.x0)*s,(b.y1-b.y0)*s); ctx.strokeRect(b.x0*s,b.y0*s,(b.x1-b.x0)*s,(b.y1-b.y0)*s); hits++; }
    }
  }
  ctx.fillStyle='#eaf'; ctx.font='18px system-ui';
  ctx.fillText(q?`Looking for "${q}" — matches: ${hits}`:'Enter a target and press Recognize',12,24);
}

snapBtn.onclick=recognizeFrame; rateEl.onchange=scheduleLoop; queryEl.onchange=recognizeFrame;
(async ()=>{ await initCamera(); scheduleLoop(); })();

/* ---------- Inline Service Worker for offline OCR ---------- */
(async function registerSW(){
  if(!('serviceWorker' in navigator)) return;
  const SW_CODE = `
    const VERSION = 'bf-v6';
    const ASSETS = [
      location.href,
      'https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js',
      'https://tessdata.projectnaptha.com/4.0.0/eng.traineddata'
    ];
    self.addEventListener('install', e=>{
      e.waitUntil(caches.open(VERSION).then(c=>c.addAll(ASSETS)));
      self.skipWaiting();
    });
    self.addEventListener('activate', e=>{
      e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==VERSION).map(k=>caches.delete(k)))));
      self.clients.claim();
    });
    self.addEventListener('fetch', e=>{
      e.respondWith(caches.open(VERSION).then(async c=>{
        const hit=await c.match(e.request);
        if(hit) return hit;
        const res=await fetch(e.request,{mode:'cors'});
        if(res && res.ok) c.put(e.request,res.clone());
        return res;
      }).catch(()=>caches.match(e.request)));
    });
  `;
  try{
    const blob = new Blob([SW_CODE], {type:'text/javascript'});
    const swUrl = URL.createObjectURL(blob);
    await navigator.serviceWorker.register(swUrl, {scope: './'});
    document.getElementById('pwa').textContent='PWA ✓';
    log('Service Worker ready ✅');
  }catch(e){ log('SW failed: '+e.message); }
})();
</script>
</body>
</html>
